{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
  <div class="rounded-md border border-sky-200 bg-sky-50 px-4 py-3 text-sm text-sky-700">
    管理后台的所有表单均直接调用 <code class="font-mono">/api/*</code> 接口，请按接口契约填写字段；
    若提交失败将展示后端返回的原始错误信息，便于排查。
  </div>
  <section class="rounded-lg border border-slate-200 bg-white shadow-sm">
    <nav class="border-b border-slate-200 px-6 pt-6" aria-label="Sections">
      <ul class="flex flex-wrap gap-3 text-sm font-medium text-slate-500">
        <li>
          <a
            href="?tab=links"
            class="inline-flex items-center gap-2 rounded-full px-4 py-2 transition-colors {% if active_tab == 'links' %}bg-sky-100 text-sky-700{% else %}hover:bg-slate-100{% endif %}"
          >
            <span class="h-2 w-2 rounded-full {% if active_tab == 'links' %}bg-sky-500{% else %}bg-slate-300{% endif %}"></span>
            短链 (
            <span
              id="short-link-count"
              hx-get="/admin/links/count"
              hx-trigger="load, refresh-links from:body"
              hx-swap="outerHTML"
            >
              {{ short_links|length }}
            </span>
            )
          </a>
        </li>
        <li>
          <a
            href="?tab=subdomains"
            class="inline-flex items-center gap-2 rounded-full px-4 py-2 transition-colors {% if active_tab == 'subdomains' %}bg-sky-100 text-sky-700{% else %}hover:bg-slate-100{% endif %}"
          >
            <span class="h-2 w-2 rounded-full {% if active_tab == 'subdomains' %}bg-sky-500{% else %}bg-slate-300{% endif %}"></span>
            子域跳转 (
            {% with count=subdomains|length %}
            {% include "admin/partials/subdomain_count.html" %}
            {% endwith %}
            )
          </a>
        </li>
      </ul>
    </nav>
    <div class="px-6 pb-6">
      {% if active_tab == 'links' %}
      <div class="mt-6 space-y-6">
        <section class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm">
          <div class="border-b border-slate-200 bg-slate-50 px-6 py-4">
            <h2 class="text-base font-semibold text-slate-800">创建短链</h2>
            <p class="mt-1 text-sm text-slate-500">
              仅需填写目标地址，可选填短链编码。提交后表格会自动刷新。
            </p>
          </div>
          <form
            class="space-y-4 px-6 py-6"
            action="/api/links"
            method="post"
            hx-post="/api/links"
            hx-trigger="submit"
            hx-target="#link-feedback"
            hx-swap="innerHTML"
            hx-on::afterRequest="if(event.detail.successful){ htmx.trigger(document.body, 'refresh-links') }"
          >
            <div class="grid gap-4 sm:grid-cols-2">
              <div>
                <label for="code" class="block text-sm font-medium text-slate-700">短链编码（可选）</label>
                <input
                  id="code"
                  name="code"
                  type="text"
                  class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
                  placeholder="留空则自动生成"
                />
              </div>
              <div class="sm:col-span-2">
                <label for="target_url" class="block text-sm font-medium text-slate-700">目标地址 *</label>
                <input
                  id="target_url"
                  name="target_url"
                  type="url"
                  required
                  class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
                  placeholder="https://example.com/path"
                />
              </div>
            </div>
            <div class="flex items-center justify-between">
              <p class="text-xs text-slate-500">
                表单直接调用 <code class="font-mono">POST /api/links</code>，遵循与外部调用一致的校验。
              </p>
              <button
                type="submit"
                class="inline-flex items-center rounded-md bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500"
              >
                保存短链
              </button>
            </div>
          </form>
          <div
            id="link-feedback"
            class="border-t border-slate-200 px-6 py-4 text-sm text-slate-500"
            role="status"
            aria-live="polite"
          ></div>
        </section>
        <section class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm">
          <div class="border-b border-slate-200 bg-slate-50 px-6 py-4">
            <h2 class="text-base font-semibold text-slate-800">短链列表</h2>
            <p class="mt-1 text-sm text-slate-500">
              列表展示当前短链、跳转目标与累计访问次数，可在操作列直接删除。
            </p>
          </div>
          <div
            id="links-table"
            class="bg-white"
            hx-get="/admin/links/table"
            hx-trigger="load, refresh-links from:body"
            hx-swap="innerHTML"
          >
            {% include "admin/partials/link_table.html" %}
          </div>
        </section>
      </div>
      {% else %}
      <div class="mt-6 space-y-6">
        <section class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm">
          <div class="border-b border-slate-200 bg-slate-50 px-6 py-4">
            <h2 class="text-base font-semibold text-slate-800">创建子域跳转</h2>
            <p class="mt-1 text-sm text-slate-500">
              Host 请填写完整域名，状态码默认为 302，可选填为 301。
            </p>
          </div>
          <form
            class="space-y-4 px-6 py-6"
            action="/api/subdomains"
            method="post"
            hx-post="/api/subdomains"
            hx-trigger="submit"
            hx-target="#subdomain-feedback"
            hx-swap="innerHTML"
            hx-on::afterRequest="if(event.detail.successful){ htmx.trigger(document.body, 'refresh-subdomains') }"
          >
            <div class="grid gap-4 sm:grid-cols-2">
              <div>
                <label for="host" class="block text-sm font-medium text-slate-700">Host *</label>
                <input
                  id="host"
                  name="host"
                  type="text"
                  required
                  class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
                  placeholder="如 foo.yet.la"
                />
              </div>
              <div>
                <label for="code" class="block text-sm font-medium text-slate-700">状态码</label>
                <input
                  id="code"
                  name="code"
                  type="number"
                  value="302"
                  min="301"
                  max="302"
                  step="1"
                  class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
                />
              </div>
              <div class="sm:col-span-2">
                <label for="target_url" class="block text-sm font-medium text-slate-700">目标地址 *</label>
                <input
                  id="target_url"
                  name="target_url"
                  type="url"
                  required
                  class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
                  placeholder="https://example.com"
                />
              </div>
            </div>
            <div class="flex items-center justify-between">
              <p class="text-xs text-slate-500">
                表单调用 <code class="font-mono">POST /api/subdomains</code>，与外部接口保持一致。
              </p>
              <button
                type="submit"
                class="inline-flex items-center rounded-md bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500"
              >
                保存子域跳转
              </button>
            </div>
          </form>
          <div
            id="subdomain-feedback"
            class="border-t border-slate-200 px-6 py-4 text-sm text-slate-500"
            role="status"
            aria-live="polite"
          ></div>
        </section>
        <section class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm">
          <div class="border-b border-slate-200 bg-slate-50 px-6 py-4">
            <h2 class="text-base font-semibold text-slate-800">子域跳转列表</h2>
            <p class="mt-1 text-sm text-slate-500">
              列表展示当前 Host、目标地址与状态码，支持直接删除。
            </p>
          </div>
          <div
            id="subdomains-table"
            class="bg-white"
            hx-get="/admin/subdomains/table"
            hx-trigger="load, refresh-subdomains from:body"
            hx-swap="innerHTML"
          >
            {% include "admin/partials/subdomain_table.html" %}
          </div>
        </section>
      </div>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}
