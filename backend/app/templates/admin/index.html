{% extends "base.html" %}

{% block content %}
<div class="theme-layout">
  <section class="theme-shell">
    <nav class="theme-tabs" aria-label="Sections">
      <a
        href="?tab=links"
        class="theme-tab {% if active_tab == 'links' %}is-active{% endif %}"
      >
        <span class="theme-tab__dot"></span>
        短链
        <span
          class="theme-tab__count"
          id="short-link-count"
          hx-get="/admin/links/count"
          hx-trigger="load, refresh-links from:body"
          hx-swap="outerHTML"
        >
          ({{ short_links|length }})
        </span>
      </a>
      <a
        href="?tab=subdomains"
        class="theme-tab {% if active_tab == 'subdomains' %}is-active{% endif %}"
      >
        <span class="theme-tab__dot"></span>
        子域
        {% with count=subdomains|length %}
        {% include "admin/partials/subdomain_count.html" %}
        {% endwith %}
      </a>
      {% if current_user and current_user.is_admin %}
      <a
        href="?tab=users"
        class="theme-tab {% if active_tab == 'users' %}is-active{% endif %}"
      >
        <span class="theme-tab__dot"></span>
        用户
        <span
          class="theme-tab__count"
          id="user-count"
          hx-get="/admin/users/count"
          hx-trigger="load, refresh-users from:body"
          hx-swap="outerHTML"
        >
          ({{ users|length }})
        </span>
      </a>
      {% endif %}
    </nav>
    <div class="theme-shell__body">
      {% if active_tab == 'links' %}
      <div class="theme-stack">
        <section class="theme-card">
          <div class="theme-card__header">
            <h2 class="theme-card__title">创建短链</h2>
            <p class="theme-card__subtitle">
              填写目标地址，可按需调整短链后缀。
            </p>
          </div>
          <div class="theme-card__body">
            <form
              class="theme-form"
              action="/api/links"
              method="post"
              hx-post="/api/links"
              hx-trigger="submit"
              hx-target="#link-feedback"
              hx-swap="innerHTML"
              data-reset-on-success="true"
              data-success-event="refresh-links"
            >
              <div class="theme-form__grid theme-form__grid--two-fixed">
                <div class="theme-field">
                  <label for="code" class="theme-label">短链（可改）</label>
                  <div class="theme-input-affix">
                    <span class="theme-input-affix__addon theme-input-affix__addon--prefix">{{ short_link_prefix }}</span>
                    <input
                      id="code"
                      name="code"
                      type="text"
                      class="theme-input-affix__input"
                      value="{{ short_code_suggestion or '' }}"
                      data-random-code="true"
                      data-random-code-length="{{ short_code_length }}"
                      autocomplete="off"
                      spellcheck="false"
                      placeholder="自动生成，可修改"
                    />
                  </div>
                </div>
                <div class="theme-field theme-form__span-full theme-field--constrained">
                  <label for="target_url" class="theme-label">目标地址 *</label>
                  <input
                    id="target_url"
                    name="target_url"
                    type="url"
                    required
                    class="theme-input"
                    placeholder="https://example.com/path"
                  />
                </div>
              </div>
              <div class="theme-form__footer theme-form__footer--center">
                <button type="submit" class="theme-button theme-button--solid">
                  创建短链
                </button>
              </div>
            </form>
          </div>
          <div
            id="link-feedback"
            class="theme-feedback"
            role="status"
            aria-live="polite"
          ></div>
        </section>
        <section class="theme-card">
          <div class="theme-card__header">
            <h2 class="theme-card__title">短链列表</h2>
            <p class="theme-card__subtitle">
              查看短链、跳转目标与访问次数，可直接复制、编辑或删除。
            </p>
          </div>
          <div
            id="links-table"
            class="theme-card__body theme-card__body--table"
            hx-get="/admin/links/table"
            hx-trigger="load, refresh-links from:body"
            hx-swap="innerHTML"
          >
            {% include "admin/partials/link_table.html" %}
          </div>
        </section>
      </div>
      {% elif active_tab == 'subdomains' %}
      <div class="theme-stack">
        <section class="theme-card">
          <div class="theme-card__header">
            <h2 class="theme-card__title">创建子域</h2>
            <p class="theme-card__subtitle">
              填写子域前缀即可，后缀 .{{ base_domain }} 将自动拼接；状态码默认为 302，支持在下拉菜单中切换。
            </p>
          </div>
          <div class="theme-card__body">
            <form
              class="theme-form"
              action="/api/subdomains"
              method="post"
              hx-post="/api/subdomains"
              hx-trigger="submit"
              hx-target="#subdomain-feedback"
              hx-swap="innerHTML"
              data-reset-on-success="true"
              data-success-event="refresh-subdomains"
            >
              <div class="theme-form__grid theme-form__grid--three">
                <div class="theme-field">
                  <label for="subdomain-prefix" class="theme-label">子域 *</label>
                  <div
                    class="theme-input-affix"
                    data-domain-input
                    data-domain-suffix="{{ base_domain }}"
                  >
                    <input
                      id="subdomain-prefix"
                      type="text"
                      required
                      class="theme-input-affix__input"
                      placeholder="如 marketing"
                      autocomplete="off"
                      spellcheck="false"
                      data-domain-input-field
                    />
                    <span class="theme-input-affix__addon theme-input-affix__addon--suffix">.{{ base_domain }}</span>
                    <input type="hidden" name="host" data-domain-input-hidden />
                  </div>
                </div>
                <div class="theme-field">
                  <label for="subdomain-code" class="theme-label">状态码</label>
                  <select id="subdomain-code" name="code" class="theme-select">
                    {% for option in subdomain_code_options %}
                    <option value="{{ option }}" {% if option == 302 %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="theme-field theme-form__span-full theme-field--constrained">
                  <label for="target_url" class="theme-label">目标地址 *</label>
                  <input
                    id="target_url"
                    name="target_url"
                    type="url"
                    required
                    class="theme-input"
                    placeholder="https://example.com"
                  />
                </div>
              </div>
              <div class="theme-form__footer theme-form__footer--center">
                <button type="submit" class="theme-button theme-button--solid">
                  创建子域
                </button>
              </div>
            </form>
          </div>
          <div
            id="subdomain-feedback"
            class="theme-feedback"
            role="status"
            aria-live="polite"
          ></div>
        </section>
        <section class="theme-card">
          <div class="theme-card__header">
            <h2 class="theme-card__title">子域列表</h2>
            <p class="theme-card__subtitle">
              快速查看子域、跳转目标与状态码，可直接复制、编辑或删除。
            </p>
          </div>
          <div
            id="subdomains-table"
            class="theme-card__body theme-card__body--table"
            hx-get="/admin/subdomains/table"
            hx-trigger="load, refresh-subdomains from:body"
            hx-swap="innerHTML"
          >
            {% include "admin/partials/subdomain_table.html" %}
          </div>
        </section>
      </div>
      {% else %}
      <div class="theme-stack">
        <section class="theme-card">
          <div class="theme-card__header">
            <h2 class="theme-card__title">创建用户</h2>
            <p class="theme-card__subtitle">
              管理员可在此创建新用户，设置邮箱与初始密码，可选择是否授予管理员权限。
            </p>
          </div>
          <div class="theme-card__body">
            <form
              class="theme-form"
              action="/api/users"
              method="post"
              hx-post="/api/users"
              hx-trigger="submit"
              hx-target="#user-feedback"
              hx-swap="innerHTML"
              data-reset-on-success="true"
              data-success-event="refresh-users"
            >
              <div class="theme-form__grid theme-form__grid--two-fixed">
                <div class="theme-field">
                  <label for="user-username" class="theme-label">用户名 *</label>
                  <input
                    id="user-username"
                    name="username"
                    type="text"
                    required
                    class="theme-input"
                    placeholder="如 alice"
                    autocomplete="off"
                    spellcheck="false"
                  />
                </div>
                <div class="theme-field">
                  <label for="user-email" class="theme-label">邮箱 *</label>
                  <input
                    id="user-email"
                    name="email"
                    type="email"
                    required
                    class="theme-input"
                    placeholder="user@example.com"
                  />
                </div>
                <div class="theme-field">
                  <label for="user-password" class="theme-label">密码 *</label>
                  <input
                    id="user-password"
                    name="password"
                    type="password"
                    minlength="6"
                    required
                    class="theme-input"
                    placeholder="至少 6 位"
                  />
                </div>
                <div class="theme-field">
                  <label for="user-password-confirm" class="theme-label">确认密码 *</label>
                  <input
                    id="user-password-confirm"
                    name="password_confirm"
                    type="password"
                    minlength="6"
                    required
                    class="theme-input"
                    placeholder="再次输入密码"
                  />
                </div>
                <div class="theme-field theme-form__span-full">
                  <div class="theme-checkbox">
                    <input type="hidden" name="is_admin" value="0" />
                    <input
                      id="create-is-admin"
                      class="theme-checkbox__control"
                      type="checkbox"
                      name="is_admin"
                      value="1"
                    />
                    <label for="create-is-admin" class="theme-checkbox__label">
                      授予管理员权限
                    </label>
                  </div>
                </div>
              </div>
              <div class="theme-form__footer theme-form__footer--center">
                <button type="submit" class="theme-button theme-button--solid">
                  创建用户
                </button>
              </div>
            </form>
          </div>
          <div
            id="user-feedback"
            class="theme-feedback"
            role="status"
            aria-live="polite"
          ></div>
        </section>
        <section class="theme-card">
          <div class="theme-card__header">
            <h2 class="theme-card__title">用户列表</h2>
            <p class="theme-card__subtitle">
              查看平台用户及权限，支持编辑资料或删除用户。
            </p>
          </div>
          <div
            id="users-table"
            class="theme-card__body theme-card__body--table"
            hx-get="/admin/users/table"
            hx-trigger="load, refresh-users from:body"
            hx-swap="innerHTML"
          >
            {% include "admin/partials/user_table.html" %}
          </div>
        </section>
      </div>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}
